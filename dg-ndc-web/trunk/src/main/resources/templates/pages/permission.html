<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="common/common_css :: common_css"></div>
    <link th:href="@{/bootstrap/css/extra.css}" rel="stylesheet" href="../../static/bootstrap/css/extra.css"/>
    <link th:href="@{/bootstrap/css/animate.css}" rel="stylesheet" href="../../static/bootstrap/css/animate.css"/>
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrapStyle.css}"
          href="/static/bootstrap/css/bootstrapStyle.css" type="text/css">
</head>

<body>
<div th:replace="pages/head :: head"></div>
<section id="main-content">
    <section class="wrapper">
        <!--page start-->
        <div id="bill_list" class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <!--头部 位置显示栏-->
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title">
                            权限管理
                        </h4>
                    </div>
                    <!--头部 位置显示栏结束-->
                </div>
                <div>
                    <ul id="treeDemo" class="ztree"></ul>
                </div>
                <input hidden id="checked_node">
                <input hidden id="uid" th:value="${uid}">
                <div class="form-group">
                    <button type="button" class="btn btn-info" data-dismiss="modal"><a href="/queryAllUser">返回</a>
                    </button>
                    <button id="update_button" class="btn btn-success" type="button">授权</button>
                </div>
            </div>
        </div>
        <!-- page end-->
    </section>
</section>

<!--引入js 文件-->
<div th:replace="common/common_js :: common_js"></div>
<script th:src="@{/bootstrap/js/ztree/jquery.ztree.core.js}"
        src="/static/bootstrap/js/ztree/jquery.ztree.core.js"></script>
<script th:src="@{/bootstrap/js/ztree/jquery.ztree.excheck.js}"
        src="/static/bootstrap/js/ztree/jquery.ztree.excheck.js"></script>
<script th:src="@{/bootstrap/js/ztree/jquery.ztree.exedit.js}"
        src="/static/bootstrap/js/ztree/jquery.ztree.exedit.js"></script>

<script type="text/javascript">

    var setting = {
        view: {
            chkStyle: "checkbox",//复选框类型
            selectedMulti: false
        },
        check: {
            enable: true
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        edit: {
            enable: false,
            drag: {
                isCopy: false,
                isMove: true,
                next: true,
                inner: true
            }
        },
        callback: {
            beforeCheck: true,
            onCheck: onCheck
        }

    };

    $(document).ready(function () {
        $.get("/index/queryMenuPermission", {uid: $("#uid").val()}, function (data) {
            $.fn.zTree.init($("#treeDemo"), setting, $.parseJSON(data));
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                node = zTree.getNodes(),
                nodes = zTree.transformToArray(node);    //遍历所有节点
            var checkedNode = "";
            for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].sortId == 1) {
                    nodes[i].checked = true;
                    zTree.updateNode(nodes[i]);
                    checkedNode += nodes[i].id + ",";
                }
            }
            $("#checked_node").append(checkedNode);
        });
    });


    /**
     * 获取选中菜单
     * @param e
     * @param treeId
     * @param treeNode
     */
    function onCheck(e, treeId, treeNode) {
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo"),
            nodes = treeObj.getCheckedNodes(true),
            checkedNode = "";
        for (var i = 0; i < nodes.length; i++) {
            checkedNode += nodes[i].id + ",";
        }
        $("#checked_node").attr("value", checkedNode);
    }


    //授权事件
    $('#update_button').click(function () {
        var nodes = $("#checked_node").val();
        var uid = $("#uid").val();
        nodes = nodes.substring(0, nodes.lastIndexOf(','));
        $.get("/index/updateMenuPermission/" + uid + "", {nodes: nodes}, function (data) {
            window.wxc.xcConfirm(data.message, window.wxc.xcConfirm.typeEnum.info, {
                onOk: function () {
                }
            });
        });
    });

</script>
</body>
</html>





