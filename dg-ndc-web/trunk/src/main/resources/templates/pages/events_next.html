<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="common/common_css :: common_css"></div>
    <!--日期插件-->
    <link th:href="@{/bootstrap/css/bootstrap-datetimepicker.min.css}"
          href="/static/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
</head>

<body>
<div th:replace="pages/head :: head"></div>
<section id="main-content">
    <section class="wrapper">
        <!--page start-->
        <div id="bill_list" class="row">
            <div class="col-lg-12">
                <div class="panel">
                    <!--头部 位置显示栏-->
                    <div class="row">
                        <div class="col-md-5">
                            <label class="select-inline">
                                <select class="form-control" id="appId" style="width: auto;">
                                    <option value="4">豆果美食-android</option>
                                    <option value="3">豆果美食-ios</option>
                                </select>
                            </label>
                        </div>
                        <div class="col-md-5"></div>
                        <div class="col-md-2">
                            <div class="input-group date form_date" data-date=""
                                 data-date-format="yyyy-MM-dd" data-link-field="dtp_input2"
                                 data-link-format="yyyy-mm-dd">
                                <input class="form-control" id="end_date" size="3" value="">
                                <span class="input-group-addon"><span
                                        class="glyphicon glyphicon-calendar"></span></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5">
                            <h4 class="page-header">
                                客户端事件管理
                            </h4>
                            <ol class="breadcrumb">
                            </ol>
                        </div>
                    </div>

                    <!--头部 位置显示栏结束-->
                    <table class="table table-striped border-top" id="sample_1">
                        <!--头部显示所包含的内容-->
                        <thead>
                        <tr>
                            <th>参数</th>
                            <th>事件名称</th>
                            <th>消息数</th>
                            <th>独立用户数</th>
                        </thead>
                        <!--头部显示所包含的内容 结束-->
                        <tbody id="tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- page end-->
    </section>
</section>


<!--引入js 文件-->
<div th:replace="common/common_js :: common_js"></div>
<script th:src="@{/bootstrap/js/jquery.dataTables.min.js}" src="/static/bootstrap/js/jquery.dataTables.min.js"></script>
<script th:src="@{/bootstrap/js/DT_bootstrap.js}" src="/static/bootstrap/js/DT_bootstrap.js"></script>
<script th:src="@{/bootstrap/js/jquery.form.js}" src="/static/bootstrap/js/jquery.form.js"></script>
<script th:src="@{/bootstrap/js/bootstrap-datetimepicker.min.js}"
        src="/static/bootstrap/js/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
<script th:src="@{/bootstrap/js/bootstrap-datetimepicker.zh-CN.js}"
        src="/static/bootstrap/js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script>

<script>

    //日期插件使用
    $('.form_date').datetimepicker({
        language: 'zh-CN',
        weekStart: 1,
        todayBtn: 1,
        autoclose: 1,
        todayHighlight: 1,
        startView: 2,
        minView: 2,
        forceParse: 0
    });

    window.onload = function () {
        $("#end_date").attr("value", getNowFormatDate);
        getChronTag("all");
    };

    /**
     * 填充结束日期
     */
    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = year + seperator1 + month + seperator1 + (strDate-1);
        return currentdate;
    }

    $("#end_date").change(function () {
        getChronTag("all");
    });

    $("#appId").change(function () {
        getChronTag("all");
    });
    /**
     * table 渲染数据
     */
    function getChronTag(obj) {
        var date=$("#end_date").val();
        var appId=$("#appId").val();
        var sAjaxSource;
        var paramKey;
        var eventCode;
        var columns;
        var param_type = obj;
        var ol = $(".breadcrumb");
        if (param_type == "all" ||  $(obj).attr("data-type")=="all") {
            param_type="all";
            sAjaxSource = "/events/queryData";
            eventCode = "";
            paramKey = "";
            columns = [
                {"data": "eventCode"},
                {"data": "eventName"},
                {"data": "pv"},
                {"data": "uv"}
            ];
            var li = '<li class="active"><a th:href="@{/events/to_page}">参数分析</a></li>';
            ol.empty();
            ol.append(li)
        } else {
            param_type = $(obj).attr("data-type");
            if (param_type == "key") {
                sAjaxSource = "/events/queryNextData";
                eventCode = $(obj).attr("id");
                paramKey = "";
                columns = [
                    {"data": "paramKey"},
                    {"data": "eventName"},
                    {"data": "pv"},
                    {"data": "uv"}
                ];
                var li = '<li class="active"><a th:href="@{/events/to_page}">参数分析</a></li>' +
                    '<li><span id="eventCode">' + eventCode + '</span></li>' +
                    '<li><a href="#" onclick="getChronTag(this)" id="' +eventCode+ '" data-type="all"><span>上一级</span></a></li>';
                ol.empty();
                ol.append(li)
            } else {
                eventCode = $("#eventCode").text();
                sAjaxSource = "/events/queryNextSubData";
                paramKey = $(obj).attr("id");
                columns = [
                    {"data": "paramValue"},
                    {"data": "eventName"},
                    {"data": "pv"},
                    {"data": "uv"}
                ];
                var li = '<li class="active"><a href="#" onclick="getChronTag(this)" id="' +eventCode+ '" data-type="all">参数分析</a></li>' +
                    '<li><span id="eventCode">' + eventCode + '</span></li>' +
                    '<li><span id="paramKey">' + paramKey + '</span></li>' +
                    '<li><a href="#"><span onclick="getChronTag(this)" id="' +eventCode + '" data-type="key">上一级</span></a></li>';
                ol.empty();
                ol.append(li)

            }
        }
        // begin first table
        $('#sample_1').dataTable(
            {
                "sDom": "<'row'<'col-sm-6'l><'col-sm-6'f>r>t<'row'<'col-sm-6'i><'col-sm-6'p>>",
                "sPaginationType": "bootstrap",
                "oLanguage": {
                    "sLengthMenu": "每页 _MENU_ 项",
                    "sSearch": "搜索:",
                    "sInfo": "当前显示第 _START_ 至 _END_ 项，共 _TOTAL_ 项。",
                    "sInfoEmpty": "当前显示第 0 至 0 项，共 0 项",
                    "sEmptyTable": "表中数据为空",
                    "sZeroRecords": "没有匹配结果",
                    "sProcessing": "处理中...",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sLoadingRecords": "载入中...",
                    "oPaginate": {
                        "sPrevious": "上一页",
                        "sNext": "下一页"
                    }
                },
                "iDisplayLength": 50,//每页的行数，每页默认数量:10
                "aLengthMenu": [50, 100, 200, "全部"],
                "bAutoWidth": false, //自适应宽度
                "bFilter": true,//是否显示搜索框
                "bProcessing": false,                   // 是否显示取数据时的那个等待提示
                "bServerSide": true,                    //这个用来指明是通过服务端来取数据
                "sAjaxSource": sAjaxSource,      //这个是请求的地址
                "fnServerData": retrieveData,            // 获取数据的处理函数
                "bSort": true, //是否支持排序功能


                //配置列要显示的数据
                "columns": columns,
                destroy: true,
                "columnDefs": [
                    {
                        "bSortable": false,
                        targets: 0,
                        defaultContent: "",
                        mRender: function (data, type, row, meta) {
                            var html = "";
                            if (param_type == "all") {
                                html = '<span onclick="getChronTag(this)" id="' + row.eventCode + '" data-type="key"><a href="#">' + row.eventCode + '</a></span> ';
                            } else if (param_type == "key") {
                                html = '<span onclick="getChronTag(this)" id="' + row.paramKey + '"  data-type="value"><a href="#">' + row.paramKey + '</a></span> ';
                            } else {
                                html = '<span>' + row.paramValue + '</span> ';
                            }
                            return html;
                        }
                    }
                ],
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            });

        // 3个参数的名字可以随便命名,但必须是3个参数,少一个都不行
        function retrieveData(sSource, aoData, fnCallback) {
            $.ajax({
                url: sSource,                              //这个就是请求地址对应sAjaxSource
                data: {
                    "appId": appId,
                    "eventCode": eventCode,
                    "paramKey": paramKey,
                    "date": date,
                    "aoData": JSON.stringify(aoData)
                },   //这个是把datatable的一些基本数据传给后台,比如起始位置,每页显示的行数 ,分页,排序,查询等的值
                type: 'get',
                dataType: 'json',
                async: false,
                success: function (result) {
                    fnCallback(result);                     //把返回的数据传给这个方法就可以了,datatable会自动绑定数据的
                },
                error: function (msg) {
                }
            });
        }


        jQuery('#sample_1 .group-checkable').change(function () {
            var set = jQuery(this).attr("data-set");
            var checked = jQuery(this).is(":checked");
            jQuery(set).each(function () {
                if (checked) {
                    $(this).attr("checked", true);
                } else {
                    $(this).attr("checked", false);
                }
            });
            jQuery.uniform.update(set);
        });

        jQuery('#sample_1_wrapper .dataTables_filter input').addClass("form-control"); // modify table search input
        jQuery('#sample_1_wrapper .dataTables_length select').addClass("form-control"); // modify table per page dropdown
    }


</script>
</body>
</html>
